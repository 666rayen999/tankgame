#include <raylib.h>
#include <stdbool.h>
#include <math.h>
#include <time.h>

//_.-* USIN DOZ TYPE NAMES BETTER *-._//
typedef __INT8_TYPE__ i8;
typedef __INT16_TYPE__ i16;
typedef __INT32_TYPE__ i32;
typedef __INT64_TYPE__ i64;
typedef __UINT8_TYPE__ u8;
typedef __UINT16_TYPE__ u16;
typedef __UINT32_TYPE__ u32;
typedef __UINT64_TYPE__ u64;
typedef __SIZE_TYPE__ usize;
typedef float f32;
typedef double f64;
typedef const char *str;

//_.-* DONT READ DIS SHI, ITS HARD I KNO *-._//
#define MAX_ENTITIES 8
#define MAX_COMPONENTS 16
typedef u8 entity_t;
typedef u16 comp_t;
#define InitECS() static comp_t Entities[MAX_ENTITIES]={};static entity_t lastEntity=0u
#define _componentManager(_0,_1,_2,_3,n,...) n
#define newComponent(...) _componentManager(__VA_ARGS__,_newComponent3,_newComponent2,_newComponent1)(__VA_ARGS__)
#define _newComponent1(id,name) static const comp_t name##ID=id
#define _newComponent2(id,name,type) _newComponent1(id,name);typedef type name##Type;static type name##_[MAX_ENTITIES]={}
#define _newComponent3(id,name,type,maxx) _newComponent1(id,name);typedef type name##Type;static type name##_[maxx]={};static entity_t _##name[MAX_ENTITIES]={};static entity_t _##name##_[maxx]={};static entity_t last##name=0u;static const entity_t max##name=maxx
#define newEntity() ++lastEntity
#define addEntity() ({entity_t ret=0u;for(entity_t id=0u;id<MAX_ENTITIES&&!ret;id++)if(!Entities[id])ret=id;ret;})+0u
#define _removeEntity(id) Entities[id]=0u
#define removeEntity() _removeEntity(id)
#define withComp(name,...) ;Entities[lastEntity]|=name##ID;name##_[last##name]=(name##Type)__VA_ARGS__;_##name##_[last##name]=lastEntity;_##name[lastEntity]=last##name++
#define withConp(name,...) ;Entities[lastEntity]|=name##ID;name##_[lastEntity]=(name##Type)__VA_ARGS__
#define _addComp(id,name,...) for(entity_t last=0u;last<max##name;last++)if(!_##name##_[last]){Entities[id]|=name##ID;_##name[id]=last;_##name##_[last]=id;name##_[last]=(name##Type)__VA_ARGS__;break;}
#define _addConp(id,name,...) Entities[id]|=name##ID;name##_[id]=(name##Type)__VA_ARGS__
#define addComp(name,...) _addComp(id,name,__VA_ARGS__)
#define addConp(name,...) _addConp(id,name,__VA_ARGS__)
#define _removeComp(id,name) Entities[id]&=~name##ID;_##name##_[_##name[id]]=0u;_##name[id]=0u
#define removeComp(name) _removeComp(id,name)
#define _removeConp(id,name) Entities[id]&=~name##ID
#define removeConp(name) _removeConp(id,name)
#define _hasComp(id,name) (Entities[id]&name##ID)
#define hasComp(name) _hasComp(id,name)
#define _hasCompN(id,name) (Entities[id]&(name))
#define hasCompN(name) _hasCompN(id,(name))
#define is(name) ;Entities[lastEntity]|=name##ID
#define _Iter1(id,name) for(entity_t id=0u;id<last##name+1u;id++)if(_##name##_[id])
#define _IterM(id,name) for(entity_t id=0u;id<max##name;id++)if(_##name##_[id])
#define _IterN(id,names) for(entity_t id=0u;id<lastEntity+1u;id++)if((Entities[id]&(names))==(names))
#define Iter1(name) _Iter1(id,name)
#define IterM(name) _IterM(id,name)
#define IterN(names) _IterN(id,names)
#define _GetN(id,name) name##_[_##name[id]]
#define _Get1(id,name) name##_[id]
#define GetN(name) _GetN(id,name)
#define Get1(name) _Get1(id,name)
#define GetID(id) (1u<<id)
#define Clean() for(entity_t id=0u;id<lastEntity+1u;id++)
#define CleanEnttt() Entities[id]=0u;lastEntity=0u
#define _CleanConp(id,name) name##_[id]=0u
#define _CleanComp(id,name) _##name##_[_##name[id]]=0u;_##name[id]=0u
#define CleanConp(name) _CleanConp(id,name)
#define CleanComp(name) _CleanComp(id,name)

#ifdef DEG2RAD
#undef DEG2RAD
#endif
#define DEG2RAD 0.01745329238f
#ifdef RAD2DEG
#undef RAD2DEG
#endif
#define RAD2DEG 57.29578018f

inline f32 Max(f32 a, f32 b) { return a > b ? a : b; }
inline f32 Min(f32 a, f32 b) { return a < b ? a : b; }
inline f32 Clamp(f32 x, f32 m, f32 M) { return Max(Min(x, M), m); }

//_.-* FO GENERATIN RNDM POS FO TANX *-._//
static u32 random = 666u;
static inline u32 Random(void)
{
  u32 x = random;
  x ^= x << 13;
	x ^= x >> 17;
	x ^= x << 5;
  random = x;
  return x;
}
//_.-* SAME SHI BUT F32 INSTEAD OF U32 *-._//
inline f32 fRandom(void)
{
  u32 x = (Random() & 0x7FFFFFu) | 0x3F800000u;
  f32 ret = *(f32*)&x;
  return ret - 1.0f;
}

typedef enum GameState {
  GameState_MENU,
  GameState_CHOOSE,
  GameState_GAME,
  GameState_PAUSE,
  GameState_WIN
} GameState;

typedef enum MenuState {
  MenuState_NONE,
  MenuState_PLAY,
  MenuState_EXIT
} MenuState;

#pragma pack(1)

//_.-* FO STORIN TEXTURES (TODO: AND SOUNDS) *-._//
static struct {
  Texture2D tankTexture;
  Texture2D deadTankTexture;
  Texture2D bulletTexture;
} Assets = {};

//_.-* GLOBAL VARIABLES I NEED *-._//
static struct {
  f32 winTime;
  u16 scoreShift;
  u8 players;
  u8 scoreBitshift;
} Res = {};

//_.-* STATES *-._//
static GameState gameState = GameState_MENU;
static MenuState menuState = MenuState_NONE;

static bool running = true;

#pragma pack()

//_.-* ECS: ENTITY-COMPONENT-SYSTEM *-._//
InitECS();

//_.-* COMPONENTS *-._//

newComponent(0x00000001u, Position, Vector2, 6);
newComponent(0x00000002u, Velocity, Vector2, 6);
newComponent(0x00000004u, Rotation, f32, 3);
newComponent(0x00000008u, Team, Color, 6);
newComponent(0x00000010u, Score, u8);

newComponent(0x00000020u, KeyLeft, u16, 2);
newComponent(0x00000040u, KeyRight, u16, 2);
newComponent(0x00000080u, KeyDown, u16, 2);
newComponent(0x00000100u, KeyUp, u16, 2);
newComponent(0x00000200u, KeyShoot, u16, 2);

newComponent(0x00000400u, ID, entity_t);

newComponent(0x00000800u, Alive);
newComponent(0x00001000u, KeyInput);
newComponent(0x00002000u, MouseInput);

newComponent(0x00004000u, Tank);
newComponent(0x00008000u, Bullet);

#define SPEED 100.0f
#define RSPEED 250.0f
#define BSPEED 500.0f

static entity_t tankID_1 = 0u, tankID_2 = 0u, tankID_3 = 0u;

//_.-* SYSTEMS *-._//

void ResetGame(void)
{
  IterN(TankID)
  {
    GetN(Position).x = fRandom()*700.0f+50.0f;
    GetN(Position).y = fRandom()*500.0f+50.0f;
    GetN(Rotation) = fRandom()*360.0f;
    Entities[id] |= AliveID;
  }
  IterN(BulletID|AliveID)
  {
    Entities[id] &= ~AliveID;
  }
}

void RenderSystem_bullet(entity_t id)
{
  DrawTexturePro(Assets.bulletTexture,
    (Rectangle){0.0f, 0.0f, 16.0f, 16.0f},
    (Rectangle){GetN(Position).x, GetN(Position).y, 16.0f, 16.0f},
    (Vector2){8.0f, 8.0f},
    0.0f, GetN(Team));
}

void RenderSystem_tank(entity_t id)
{
  DrawTexturePro(hasComp(Alive) ? Assets.tankTexture : Assets.deadTankTexture,
    (Rectangle){0.0f, 0.0f, 64.0f, 64.0f},
    (Rectangle){GetN(Position).x, GetN(Position).y, 64.0f, 64.0f},
    (Vector2){32.0f, 32.0f},
    GetN(Rotation), GetN(Team));
}

void RenderSystemGAME(void)
{
  IterN(TeamID|PositionID|BulletID|AliveID) RenderSystem_bullet(id);
  u8 playerCount = 0u;
  IterN(TeamID|PositionID|TankID|ScoreID)
    RenderSystem_tank(id);
  DrawRectangle(0, 530, 800, 70, CLITERAL(Color){ 100, 100, 100, 50 });
  IterN(TeamID|ScoreID|TankID)
    DrawText(TextFormat("%04u", Get1(Score)), ((playerCount++)<<Res.scoreBitshift)+Res.scoreShift, 550, 32, GetN(Team));
}

void RenderSystemWIN(void)
{
  RenderSystemGAME();
}

void RenderSystemMENU(void)
{
  DrawText("TANK", (800u-MeasureText("TANK", 200))>>1u, 90, 200, CLITERAL(Color){ 140, 20, 40, 255 });
  DrawText("TANK", (800u-MeasureText("TANK", 200))>>1u, 80, 200, CLITERAL(Color){ 180, 30, 50, 255 });
  DrawText("TANK", (800u-MeasureText("TANK", 200))>>1u, 70, 200, CLITERAL(Color){ 220, 40, 60, 255 });
  DrawRectangleRounded((Rectangle){250.0f, 320.0f, 300.0f, 60.0f}, 0.5f, 4, menuState==MenuState_PLAY?RED:BLACK);
  DrawRectangleRounded((Rectangle){250.0f, 400.0f, 300.0f, 60.0f}, 0.5f, 4, menuState==MenuState_EXIT?RED:BLACK);
  DrawText("PLAY", (800u-MeasureText("PLAY", 50))>>1u, 327, 50, menuState==MenuState_PLAY?BLACK:RED);
  DrawText("EXIT", (800u-MeasureText("EXIT", 50))>>1u, 407, 50, menuState==MenuState_EXIT?BLACK:RED);
  DrawText("By Rayen (c) 666", 10, 570, 20, BLACK);
}

void InputSystem_Key(entity_t id, f32 dt)
{
  if (IsKeyDown(GetN(KeyLeft))) GetN(Rotation) -= RSPEED * dt;
  if (IsKeyDown(GetN(KeyRight))) GetN(Rotation) += RSPEED * dt;
  entity_t b_id = Get1(ID);

  bool k1 = IsKeyDown(GetN(KeyUp));
  bool k2 = IsKeyDown(GetN(KeyDown));
  bool k3 = IsKeyDown(GetN(KeyShoot)) && !_hasComp(b_id, Alive);

  if (!k1 && !k2 && !k3)
  {
    GetN(Velocity) = (Vector2){};
    return;
  }

  f32 x = sinf(GetN(Rotation) * DEG2RAD);
  f32 y = -cosf(GetN(Rotation) * DEG2RAD);

  if (k1) GetN(Velocity) = (Vector2){x * SPEED, y * SPEED};
  else if (k2) GetN(Velocity) = (Vector2){-x * SPEED, -y * SPEED};
  else GetN(Velocity) = (Vector2){};

  if (k3)
  {
    _GetN(b_id, Position) = (Vector2){
      GetN(Position).x + x * 24.0f,
      GetN(Position).y + y * 24.0f
    };
    _GetN(b_id, Velocity) = (Vector2){x * BSPEED, y * BSPEED};
    Entities[b_id] |= AliveID;
  }
}

void InputSystem_Mouse(entity_t id, f32 dt)
{
  Vector2 mousePos = GetMousePosition();
  f32 dX = mousePos.x - GetN(Position).x;
  f32 dY = mousePos.y - GetN(Position).y;
  entity_t b_id = Get1(ID);

  bool k1 = IsMouseButtonPressed(MOUSE_LEFT_BUTTON) && !_hasComp(b_id, Alive);

  f32 length = Clamp(sqrtf(dX * dX + dY * dY) * 0.1f - 1.0f, 0.0f, 1.0f) * SPEED;
  f32 angle = atan2f(dX, -dY);
  GetN(Rotation) = angle * RAD2DEG;

  f32 x = sinf(GetN(Rotation) * DEG2RAD);
  f32 y = -cosf(GetN(Rotation) * DEG2RAD);

  GetN(Velocity) = (Vector2){x * length, y * length};
  if (k1)
  {
    _GetN(b_id, Position) = (Vector2){
      GetN(Position).x + x * 24.0f,
      GetN(Position).y + y * 24.0f
    };
    _GetN(b_id, Velocity) = (Vector2){x * BSPEED, y * BSPEED};
    Entities[b_id] |= AliveID;
  }
}

void InputSystemGAME(f32 dt)
{
  if (IsKeyPressed(KEY_P))
    gameState = GameState_PAUSE;
  if (IsKeyPressed(KEY_ESCAPE))
  {
    ResetGame();
    Res.players = 0u;
    Entities[tankID_1] &= ~TankID;
    Entities[tankID_2] &= ~TankID;
    Entities[tankID_3] &= ~TankID;
    Score_[tankID_1] = 0u;
    Score_[tankID_2] = 0u;
    Score_[tankID_3] = 0u;
    gameState = GameState_MENU;
  }
  IterN(TankID|AliveID)
  {
    if hasCompN(KeyInputID) InputSystem_Key(id, dt);
    else if hasCompN(MouseInputID) InputSystem_Mouse(id, dt);
  }
}

void InputSystemMENU(f32 empty)
{
  u32 x = GetMouseX();
  u32 y = GetMouseY();
  menuState = MenuState_NONE;
  if (IsKeyPressed(KEY_ESCAPE))
    running = false;
  if (x - 250u < 300u)
  {
    if (y - 320u < 60u) menuState = MenuState_PLAY;
    else if (y - 400u < 60u) menuState = MenuState_EXIT;
  }
  if (IsMouseButtonPressed(MOUSE_LEFT_BUTTON))
  {
    if (menuState == MenuState_PLAY) gameState = GameState_CHOOSE;
    else if (menuState == MenuState_EXIT) running = false;
  }
}

void UpdateSystem_tank(entity_t id, f32 dt)
{
  GetN(Position).x = Clamp(GetN(Position).x + GetN(Velocity).x * dt, 20.0f, 780.0f);;
  GetN(Position).y = Clamp(GetN(Position).y + GetN(Velocity).y * dt, 20.0f, 580.0f);;
}

void UpdateSystem_bulletTankCollision(entity_t b_id)
{
  #define Square(x) ((x)*(x))
  Vector2 bulletPos = _GetN(b_id, Position);
  IterN(PositionID|TankID|AliveID)
  {
    Vector2 tankPos = GetN(Position);
    if (Square(bulletPos.x - tankPos.x) + Square(bulletPos.y - tankPos.y) < Square(24.0f))
    {
      Entities[id]&=~AliveID;
      _Get1(_Get1(b_id, ID), Score)++;
      Entities[b_id]&=~AliveID;
      return;
    }
  }
  #undef Square
}

void UpdateSystem_bullet(entity_t id, f32 dt)
{
  GetN(Position).x += GetN(Velocity).x * dt;
  GetN(Position).y += GetN(Velocity).y * dt;
  if ( GetN(Position).x < 0.0f
    || GetN(Position).x > 800.0f
    || GetN(Position).y < 0.0f
    || GetN(Position).y > 600.0f
  ) { Entities[id]&=~AliveID; return; }
  UpdateSystem_bulletTankCollision(id);
}

void UpdateSystemGAME(f32 dt)
{
  u8 alive = 0u;
  IterN(PositionID|VelocityID|AliveID)
  {
    if (hasCompN(TankID)) { UpdateSystem_tank(id, dt); alive++; }
    else if (hasCompN(BulletID)) UpdateSystem_bullet(id, dt);
  }
  if (alive < 2u)
    gameState = GameState_WIN;
}

void NothingSystem(f32 empty) { return; }

void UpdateSystemWIN(f32 dt)
{
  UpdateSystemGAME(dt);
  Res.winTime += dt;
  if (Res.winTime > 1.0f)
  {
    ResetGame();
    Res.winTime = 0.0f;
    gameState = GameState_GAME;
  }
}

void RenderSystemPAUSE(void)
{
  RenderSystemGAME();
  DrawRectangle(0, 0, 800, 600, CLITERAL(Color){ 0, 0, 0, 100 });
  DrawText("PAUSED", (800u-MeasureText("PAUSED", 100))>>1u, 250, 100, RED);
}

void InputSystemPAUSE(f32 empty)
{
  if (IsKeyPressed(KEY_P) || IsKeyPressed(KEY_ESCAPE))
    gameState = GameState_GAME;
}

void InputSystemCHOOSE(f32 empty)
{
  if (IsKeyPressed(KEY_ESCAPE))
  {
    Res.players = 0u;
    Entities[tankID_1] &= ~TankID;
    Entities[tankID_2] &= ~TankID;
    Entities[tankID_3] &= ~TankID;
    gameState = GameState_MENU;
  }
  if (IsKeyPressed(KEY_H) && !(Entities[tankID_1] & TankID))
  {
    Res.players++;
    Entities[tankID_1] |= TankID;
  }
  if (IsKeyPressed(KEY_L) && !(Entities[tankID_2] & TankID))
  {
    Res.players++;
    Entities[tankID_2] |= TankID;
  }
  if (IsMouseButtonPressed(MOUSE_LEFT_BUTTON) && !(Entities[tankID_3] & TankID))
  {
    Res.players++;
    Entities[tankID_3] |= TankID;
  }
  if (IsKeyPressed(KEY_ENTER) && Res.players > 1u)
  {
    gameState = GameState_GAME;
    if (Res.players < 2u) {
      Res.scoreShift = 360u;
    } else {
      Res.scoreBitshift = Res.players == 2u ? 9u : 8u;
      Res.scoreShift = 100u;
    }
  }
}

void RenderSystemCHOOSE(void)
{
  DrawTexturePro(Assets.tankTexture,
    (Rectangle){0.0f, 0.0f, 64.0f, 64.0f},
    (Rectangle){150.0f, 200.0f, 200.0f, 200.0f},
    (Vector2){100.0f, 100.0f},
    0.0f, GREEN);
  DrawTexturePro(Assets.tankTexture,
    (Rectangle){0.0f, 0.0f, 64.0f, 64.0f},
    (Rectangle){400.0f, 200.0f, 200.0f, 200.0f},
    (Vector2){100.0f, 100.0f},
    0.0f, RED);
  DrawTexturePro(Assets.tankTexture,
    (Rectangle){0.0f, 0.0f, 64.0f, 64.0f},
    (Rectangle){650.0f, 200.0f, 200.0f, 200.0f},
    (Vector2){100.0f, 100.0f},
    0.0f, BLUE);
  bool k1 = Entities[tankID_1] & TankID;
  bool k2 = Entities[tankID_2] & TankID;
  bool k3 = Entities[tankID_3] & TankID;
  if (k1) DrawRectangleRounded((Rectangle){100.0f, 300.0f, 100.0f, 100.0f}, 0.5f, 4, GRAY);
  else DrawRectangleRoundedLines((Rectangle){110.0f, 310.0f, 80.0f, 80.0f}, 0.5f, 4, 8.0f, GRAY);
  if (k2) DrawRectangleRounded((Rectangle){350.0f, 300.0f, 100.0f, 100.0f}, 0.5f, 4, GRAY);
  else DrawRectangleRoundedLines((Rectangle){360.0f, 310.0f, 80.0f, 80.0f}, 0.5f, 4, 8.0f, GRAY);
  if (k3) DrawRectangleRounded((Rectangle){600.0f, 300.0f, 100.0f, 100.0f}, 0.5f, 4, GRAY);
  else DrawRectangleRoundedLines((Rectangle){610.0f, 310.0f, 80.0f, 80.0f}, 0.5f, 4, 8.0f, GRAY);
  DrawText("H", 150-(MeasureText("H", 80)>>1u), 315, 80, k1 ? LIGHTGRAY : GRAY);
  DrawText("L", 400-(MeasureText("L", 80)>>1u), 315, 80, k2 ? LIGHTGRAY : GRAY);
  DrawText("CLICK", 650-(MeasureText("CLICK", 20)>>1u), 340, 20, k3 ? LIGHTGRAY : GRAY);
  DrawText("CLICK ENTER TO PLAY", (800-MeasureText("CLICK ENTER TO PLAY", 20))>>1u, 500, 20, RED);
}

#define CreateTankRED(x,y,r) newEntity()is(Bullet)withComp(Position,{})withComp(Velocity,{})withComp(Team,RED)withConp(ID,lastEntity+1u);newEntity()is(Alive)is(KeyInput)withComp(KeyLeft,KEY_LEFT)withComp(KeyRight,KEY_RIGHT)withComp(KeyUp,KEY_UP)withComp(KeyDown,KEY_DOWN)withComp(KeyShoot,KEY_L)withComp(Rotation,r)withComp(Position,{x,y})withComp(Velocity,{})withComp(Team,RED)withConp(ID,lastEntity-1u)withConp(Score,0u);tankID_1=lastEntity
#define CreateTankGREEN(x,y,r) newEntity()is(Bullet)withComp(Position,{})withComp(Velocity,{})withComp(Team,GREEN)withConp(ID,lastEntity+1u);newEntity()is(Alive)is(KeyInput)withComp(KeyLeft,KEY_S)withComp(KeyRight,KEY_F)withComp(KeyUp,KEY_E)withComp(KeyDown,KEY_D)withComp(KeyShoot,KEY_H)withComp(Rotation,r)withComp(Position,{x,y})withComp(Velocity,{})withComp(Team,GREEN)withConp(ID,lastEntity-1u)withConp(Score,0u);tankID_2=lastEntity
#define CreateTankBLUE(x,y,r) newEntity()is(Bullet)withComp(Position,{})withComp(Velocity,{})withComp(Team,BLUE)withConp(ID,lastEntity+1u);newEntity()is(Alive)is(MouseInput)withComp(Rotation,r)withComp(Position,{x,y})withComp(Velocity,{})withComp(Team,BLUE)withConp(ID,lastEntity-1u)withConp(Score,0u);tankID_3=lastEntity

#define Check(type,max) printf("(%s) Comp: %zu \t Conp: %zu \t %.2f%% \t %3s %s\n",(2u+((sizeof(type)+sizeof(entity_t))*max)+(sizeof(entity_t)*MAX_ENTITIES)<sizeof(type)*MAX_ENTITIES)?"V":"X",2u+((sizeof(type)+sizeof(entity_t))*max)+(sizeof(entity_t)*MAX_ENTITIES),sizeof(type)*MAX_ENTITIES,100.0f*(f32)((2u+((sizeof(type)+sizeof(entity_t))*max)+(sizeof(entity_t)*MAX_ENTITIES)))/(f32)(sizeof(type)*MAX_ENTITIES),#max,#type)

int main(void)
{
  SetTraceLogLevel(LOG_NONE);
  SetConfigFlags(FLAG_MSAA_4X_HINT | FLAG_VSYNC_HINT);
  InitWindow(800, 600, "Tank Game");
  SetExitKey(KEY_NULL);
  SetTargetFPS(60);

  random = time(NULL);

  Image tankImage = {};
  Image deadTankImage = {};
  Image bulletImage = {};

  {
    u8 tank_png[] = {0x89u,0x50u,0x4eu,0x47u,0x0du,0x0au,0x1au,0x0au,0x00u,0x00u,0x00u,0x0du,0x49u,0x48u,0x44u,0x52u,0x00u,0x00u,0x00u,0x40u,0x00u,0x00u,0x00u,0x40u,0x08u,0x03u,0x00u,0x00u,0x00u,0x9du,0xb7u,0x81u,0xecu,0x00u,0x00u,0x00u,0x45u,0x50u,0x4cu,0x54u,0x45u,0x00u,0x00u,0x00u,0xc7u,0xc7u,0xc7u,0xc7u,0xc7u,0xc7u,0xc6u,0xc6u,0xc6u,0xc7u,0xc7u,0xc7u,0xc8u,0xc8u,0xc8u,0xc8u,0xc8u,0xc8u,0xc7u,0xc7u,0xc7u,0xc8u,0xc8u,0xc8u,0xfau,0xfau,0xfau,0xc8u,0xc8u,0xc8u,0xf1u,0xf1u,0xf1u,0xd8u,0xd8u,0xd8u,0xc7u,0xc7u,0xc7u,0xd6u,0xd6u,0xd6u,0xebu,0xebu,0xebu,0xceu,0xceu,0xceu,0xf6u,0xf6u,0xf6u,0xf3u,0xf3u,0xf3u,0xdeu,0xdeu,0xdeu,0xecu,0xecu,0xecu,0xe6u,0xe6u,0xe6u,0xdfu,0xdfu,0xdfu,0x38u,0x4bu,0xcfu,0xeeu,0x00u,0x00u,0x00u,0x09u,0x74u,0x52u,0x4eu,0x53u,0x00u,0xc5u,0xedu,0x4du,0x4au,0xf1u,0xb9u,0x82u,0xc6u,0x0du,0x37u,0x65u,0x6eu,0x00u,0x00u,0x00u,0xf7u,0x49u,0x44u,0x41u,0x54u,0x58u,0xc3u,0xedu,0x95u,0xddu,0x0eu,0x83u,0x20u,0x0cu,0x85u,0x85u,0xe9u,0xb6u,0x1eu,0x04u,0x75u,0xceu,0xbdu,0xffu,0xa3u,0x8eu,0x98u,0x28u,0x2eu,0xa0u,0x25u,0x2cu,0xfeu,0x5cu,0xf0u,0xddu,0x9eu,0xf8u,0xa9u,0x85u,0xb6u,0xc5u,0xa5u,0xb9u,0x89u,0x0au,0x96u,0x4au,0x94u,0x89u,0xcfu,0x63u,0x26u,0xcdu,0x20u,0x50u,0x2bu,0xb2u,0xa8u,0x1au,0x22u,0x49u,0x20u,0xa1u,0x68u,0x44u,0x41u,0xeeu,0x2du,0xe0u,0x7fu,0xe1u,0x8cu,0x22u,0x3au,0x83u,0xd6u,0x65u,0x91u,0x08u,0x40u,0x16u,0xa0u,0xc8u,0x82u,0x63u,0x04u,0xaeu,0x01u,0xe7u,0xf6u,0x73u,0x02u,0x2fu,0xe3u,0xefu,0x4eu,0xe9u,0x0bu,0x5cu,0xc6u,0xdcu,0xdeu,0xf9u,0xeeu,0x3au,0x81u,0x97u,0x71u,0xfdu,0xa3u,0x20u,0x1fu,0x77u,0x89u,0x05u,0xf2u,0xfeu,0x70u,0x19u,0x57u,0x35u,0x0bu,0x34u,0x3cu,0xf4u,0x94u,0x81u,0x17u,0x34u,0x80u,0x51u,0x1du,0x2du,0xe8u,0x94u,0x01u,0x1au,0x5eu,0x30u,0xbfu,0xecu,0x43u,0x1eu,0x3du,0xa6u,0xefu,0x62u,0x05u,0x1au,0x86u,0x02u,0x98u,0x28u,0x01u,0x59u,0x6au,0xbcu,0x43u,0x82u,0x06u,0x75u,0x64u,0x0du,0x5au,0x74u,0x21u,0xc1u,0x0bu,0x6du,0xa4u,0x00u,0xa0u,0x20u,0xc0u,0x01u,0x82u,0x91u,0x55u,0xc1u,0xc8u,0xdfu,0x82u,0xcbu,0xd7u,0xe0u,0x7cu,0x41u,0x3eu,0x85u,0xcdu,0x66u,0xeau,0xa2u,0x9bu,0xc9u,0xacu,0xb5u,0xb3u,0x21u,0xcbu,0xceu,0x03u,0x65u,0x32u,0xf4u,0xc1u,0x91u,0x36u,0x12u,0x39u,0x54u,0xdbu,0xe1u,0xf5u,0x33u,0x4cu,0x86u,0x96u,0x19u,0xaau,0x69u,0x63u,0x3du,0x7du,0xb1u,0xf0u,0xabu,0x8du,0xcbu,0xf8u,0xe5u,0xcau,0x67u,0x61u,0xc3u,0xb3u,0x02u,0xa4u,0x28u,0x37u,0xb3u,0x4cu,0x26u,0x93u,0x09u,0xf2u,0x05u,0x98u,0x28u,0x2du,0xecu,0xd6u,0x08u,0x20u,0xfbu,0x00u,0x00u,0x00u,0x00u,0x49u,0x45u,0x4eu,0x44u,0xaeu,0x42u,0x60u,0x82u};
    tankImage = LoadImageFromMemory(".png", tank_png, 406);
    SetWindowIcon(tankImage);
  }{
    u8 deadtank_png[] = {0x89u,0x50u,0x4eu,0x47u,0x0du,0x0au,0x1au,0x0au,0x00u,0x00u,0x00u,0x0du,0x49u,0x48u,0x44u,0x52u,0x00u,0x00u,0x00u,0x40u,0x00u,0x00u,0x00u,0x40u,0x08u,0x03u,0x00u,0x00u,0x00u,0x9du,0xb7u,0x81u,0xecu,0x00u,0x00u,0x00u,0x90u,0x50u,0x4cu,0x54u,0x45u,0x00u,0x00u,0x00u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x56u,0x56u,0x56u,0x56u,0x56u,0x56u,0x4du,0x4du,0x4du,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x56u,0x56u,0x56u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x58u,0x58u,0x58u,0x57u,0x57u,0x57u,0x56u,0x56u,0x56u,0x58u,0x58u,0x58u,0x55u,0x55u,0x55u,0x57u,0x57u,0x57u,0x56u,0x56u,0x56u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x56u,0x56u,0x56u,0x57u,0x57u,0x57u,0x55u,0x55u,0x55u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x57u,0x53u,0x53u,0x53u,0x57u,0x57u,0x57u,0x58u,0x58u,0x58u,0x58u,0x58u,0x58u,0x57u,0x57u,0x57u,0x58u,0x58u,0x58u,0x56u,0x56u,0x56u,0x57u,0x57u,0x57u,0x6du,0x6du,0x6du,0x57u,0x57u,0x57u,0x5au,0x5au,0x5au,0x5du,0x5du,0x5du,0x6au,0x6au,0x6au,0x62u,0x62u,0x62u,0x67u,0x67u,0x67u,0x5fu,0x5fu,0x5fu,0x64u,0x64u,0x64u,0x19u,0x04u,0x78u,0x08u,0x00u,0x00u,0x00u,0x27u,0x74u,0x52u,0x4eu,0x53u,0x00u,0xf9u,0x99u,0xceu,0xd3u,0x2cu,0x11u,0x05u,0xf3u,0xefu,0x64u,0xe9u,0xdbu,0xb9u,0xa6u,0x6bu,0x3bu,0x24u,0x1au,0xcau,0x94u,0x8cu,0x84u,0x5du,0x58u,0x1fu,0xe9u,0x7cu,0x51u,0x49u,0x35u,0x17u,0xe4u,0x9eu,0x74u,0x4cu,0x30u,0xb0u,0xc1u,0x4bu,0x10u,0x00u,0x13u,0x00u,0x00u,0x02u,0xc6u,0x49u,0x44u,0x41u,0x54u,0x58u,0xc3u,0xedu,0x56u,0xd9u,0x92u,0xdau,0x30u,0x10u,0xc4u,0xd8u,0x80u,0xb9u,0x61u,0x39u,0x96u,0x65u,0x97u,0xbdu,0x37u,0xf4u,0x8cu,0xaeu,0xffu,0xffu,0xbbu,0x58u,0x63u,0xd9u,0x78u,0x13u,0xacu,0x54u,0x5cu,0x95u,0x97u,0x14u,0xfdu,0x82u,0xb1u,0x34u,0x6du,0x4du,0x4fu,0x8fu,0xa4u,0xdeu,0xbfu,0xc7u,0xcbu,0xf3u,0x6au,0xd4u,0x39u,0xf8u,0xf4u,0x96u,0xe5u,0x00u,0x92u,0x7eu,0x47u,0x8au,0x05u,0x3cu,0x88u,0x80u,0x6du,0xa7u,0xf8u,0x03u,0xa0u,0xd5u,0xb9u,0x80u,0x41u,0x32u,0xecu,0x42u,0xb0u,0x83u,0x3eu,0x97u,0x60u,0x1cu,0xbau,0x10u,0x6cu,0x1bu,0x04u,0x4fu,0x5du,0x08u,0xeeu,0x41u,0x3eu,0x03u,0x65u,0x2cu,0xf0u,0xd0u,0x85u,0x60u,0x78u,0x04u,0x98u,0xe0u,0xb1u,0xecu,0x75u,0xc2u,0x12u,0x25u,0x8eu,0x83u,0x5eu,0x57u,0x02u,0x36u,0xeau,0xecu,0xb0u,0x90u,0x7fu,0x9du,0xcbu,0xa0u,0xb1u,0xefu,0x4au,0xf0u,0x05u,0x53u,0x10u,0x58u,0xdcu,0x77u,0x25u,0xc8u,0xa0u,0xa4u,0x86u,0xabu,0xaeu,0x04u,0x09u,0xceu,0x05u,0x08u,0x2fu,0x7fu,0xd3u,0x7bu,0xebu,0x8bu,0x69u,0xefu,0x40u,0x9eu,0x00u,0x49u,0xfdu,0x66u,0xb4u,0xbeu,0x8bu,0x87u,0x8fu,0x06u,0xbbu,0x2cu,0x1fu,0xa7u,0x8bu,0xa5u,0xf8u,0x66u,0x05u,0xf6u,0x3eu,0x42u,0x26u,0x63u,0x83u,0xc9u,0x5bu,0x3au,0x4eu,0xb7u,0xf1u,0x8au,0x3eu,0xf4u,0x41u,0x00u,0x92u,0xd9u,0xdeu,0xafu,0x63u,0x02u,0x2bu,0x9du,0xf4u,0xe5u,0x87u,0x3eu,0x36u,0x39u,0x00u,0xc2u,0x62u,0x1du,0x23u,0xf8u,0x78u,0xa5u,0xa2u,0xffu,0x8cu,0xa6u,0x99u,0xf7u,0xfeu,0x3eu,0x54u,0x71u,0x57u,0x3cu,0x7fu,0x66u,0x60u,0xadu,0x94u,0xa3u,0x69u,0xb4u,0x24u,0xefu,0x89u,0xf5u,0x59u,0x2bu,0x3bu,0xfeu,0x31u,0x9fu,0xa2u,0x81u,0x69u,0x96u,0xb3u,0xf1u,0x43u,0x3au,0xe9u,0xc7u,0x08u,0xfau,0x70u,0xa1u,0xfbu,0xaeu,0x40u,0x08u,0x0cu,0xd2u,0x18u,0xc1u,0x1cu,0x5au,0xc9u,0x2cu,0x70u,0xf1u,0xdbu,0x84u,0x62u,0x61u,0x50u,0x06u,0x18u,0x45u,0x9du,0x53u,0x80u,0x18u,0xd0u,0xcdu,0x60u,0xa3u,0x3du,0xadu,0xaeu,0x5au,0xf3u,0x39u,0xe6u,0x9cu,0x30u,0x87u,0x9bu,0xf1u,0x9au,0x40u,0x26u,0xe4u,0x45u,0x4cu,0x91u,0xd6u,0x0eu,0xceu,0x51u,0x0cu,0x13u,0x62u,0x7du,0x1eu,0x8eu,0x48u,0x8bu,0x32u,0x46u,0xf2u,0x72u,0x88u,0xa8u,0xb8u,0x2au,0x3fu,0x4du,0xa8u,0xd6u,0xceu,0x45u,0xa4u,0x85u,0x0eu,0x6cu,0xa0u,0x3fu,0xa9u,0x78u,0x80u,0x54u,0x11u,0x15u,0x01u,0x93u,0xf1u,0x2bu,0x10u,0x82u,0xfau,0x7du,0x4cu,0xc5u,0x47u,0xb0u,0x52u,0x17u,0x02u,0x45u,0xb2u,0x20u,0x67u,0x1au,0x04u,0xcau,0x51u,0x44u,0xc5u,0x3eu,0x3cu,0x08u,0xa8u,0xd4u,0xb3u,0xe7u,0x26u,0x00u,0x86u,0xc7u,0x24u,0x62u,0x03u,0x2eu,0xabu,0x50u,0x65u,0xf0u,0xddu,0x0cu,0xc2u,0x6eu,0x39u,0xa2u,0xe2u,0x0cu,0xb2u,0x8du,0x07u,0x02u,0x47u,0x5cu,0x8bu,0x19u,0xb4u,0x31u,0xa2u,0xe2u,0x26u,0xbeu,0x81u,0xc8u,0x44u,0xcdu,0xccu,0x44u,0xa6u,0xd2u,0x82u,0x74u,0x43u,0x5cu,0x24u,0x11u,0x1bu,0x04u,0x02u,0x02u,0x51u,0x88u,0xb2u,0x6cu,0x58u,0x9eu,0x6au,0x82u,0x76u,0x15u,0x57u,0x20u,0xa3u,0x4au,0xb1u,0xb4u,0x51u,0xb5u,0x0fu,0x89u,0xb8u,0x51u,0x46u,0xa3u,0xa9u,0x55u,0xc5u,0x03u,0xaau,0x56u,0x68u,0x4au,0x67u,0xe1u,0x79u,0x95u,0xd3u,0x0eu,0xb0u,0x22u,0x71u,0xabu,0x8au,0x8fu,0x62u,0x75u,0xa9u,0x42u,0x13u,0x0cu,0x49u,0x08u,0xe5u,0x10u,0x6bu,0x8du,0x4du,0x74u,0x37u,0x50u,0xeau,0x42u,0xa0u,0x59u,0xc4u,0xb4u,0xccu,0x6cu,0x8bu,0x40u,0x38u,0x15u,0x55u,0x71u,0x0eu,0x73u,0xc9u,0x55u,0xc9u,0x99u,0x42u,0x05u,0x9au,0x56u,0x16u,0x10u,0x3eu,0x63u,0x36u,0x08u,0x13u,0x75u,0x5du,0xc4u,0x4au,0x4eu,0x85u,0xf0u,0x01u,0xdbu,0xa6u,0x62u,0x02u,0x17u,0xaau,0x60u,0x42u,0x23u,0x7du,0x83u,0x81u,0x4fu,0x51u,0xf9u,0x32u,0x6cu,0x5bu,0x6cu,0x50u,0x57u,0x81u,0xafu,0x11u,0x30u,0x6au,0x91u,0x37u,0x6du,0x36u,0xb0u,0x61u,0x02u,0xf4u,0x99u,0x48u,0x7du,0x8fu,0xd7u,0xc8u,0x4bu,0x7eu,0x6du,0x5au,0x54u,0xbcu,0x87u,0x95u,0x54u,0x35u,0x52u,0x80u,0xc0u,0x8du,0x60u,0xe9u,0x62u,0x3cu,0x01u,0x46u,0x45u,0x54u,0x7cu,0x4fu,0x4au,0xb9u,0x1du,0xfau,0xa7u,0x23u,0x7eu,0xc3u,0xf1u,0xd4u,0x4bu,0x83u,0x8au,0x9cu,0x1fu,0xaeu,0xfau,0x68u,0x6cu,0x85u,0xdfu,0x26u,0xefu,0xbdu,0xe1u,0xfeu,0x97u,0x83u,0x65u,0xfeu,0x38u,0x2cu,0x8cu,0x52u,0x7eu,0xc2u,0xf0u,0xebu,0xd5u,0x32u,0x3cu,0xcdu,0x48u,0x9bu,0x22u,0x03u,0x7au,0xfdu,0x68u,0xbbu,0xb6u,0x4du,0xc9u,0x29u,0xa5u,0x19u,0xd9u,0xd5u,0x23u,0x76u,0xb8u,0x9fu,0x25u,0x00u,0x08u,0xfdu,0xb6u,0x3bu,0xddu,0x7au,0x21u,0x7eu,0xceu,0x37u,0xa7u,0x96u,0xb3u,0x79u,0xb9u,0x48u,0xc7u,0xe3u,0x6cu,0x37u,0x68u,0xddu,0x35u,0x07u,0xdbu,0xe2u,0x84u,0x7fu,0x9bu,0x44u,0x8fu,0xf8u,0xe1u,0x3au,0x76u,0x1fu,0xb9u,0x5bu,0x8fu,0x7au,0x37u,0xdcu,0x70u,0xc3u,0x7fu,0x8au,0x9fu,0x61u,0x55u,0xc3u,0xe0u,0xddu,0x64u,0xa3u,0x54u,0x00u,0x00u,0x00u,0x00u,0x49u,0x45u,0x4eu,0x44u,0xaeu,0x42u,0x60u,0x82u};
    deadTankImage = LoadImageFromMemory(".png", deadtank_png, 974);
  }{
    u8 bullet_png[] = {0x89u,0x50u,0x4eu,0x47u,0x0du,0x0au,0x1au,0x0au,0x00u,0x00u,0x00u,0x0du,0x49u,0x48u,0x44u,0x52u,0x00u,0x00u,0x00u,0x10u,0x00u,0x00u,0x00u,0x10u,0x08u,0x03u,0x00u,0x00u,0x00u,0x28u,0x2du,0x0fu,0x53u,0x00u,0x00u,0x00u,0x4bu,0x50u,0x4cu,0x54u,0x45u,0x00u,0x00u,0x00u,0x14u,0x14u,0x14u,0x13u,0x13u,0x13u,0x00u,0x00u,0x00u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x12u,0x12u,0x12u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x12u,0x12u,0x12u,0x13u,0x13u,0x13u,0x13u,0x13u,0x13u,0x12u,0x12u,0x12u,0x13u,0x13u,0x13u,0x0fu,0x0fu,0x0fu,0x12u,0x12u,0x12u,0x14u,0x14u,0x14u,0x32u,0x32u,0x32u,0x20u,0x20u,0x20u,0x1au,0x1au,0x1au,0x18u,0x18u,0x18u,0x29u,0x29u,0x29u,0xc8u,0xccu,0xd4u,0x50u,0x00u,0x00u,0x00u,0x13u,0x74u,0x52u,0x4eu,0x53u,0x00u,0x67u,0x33u,0x05u,0xe6u,0x7fu,0x46u,0x42u,0xebu,0xceu,0x35u,0x77u,0x71u,0x69u,0x5cu,0x57u,0x37u,0x11u,0x0eu,0xdau,0x64u,0x35u,0x97u,0x00u,0x00u,0x00u,0x6bu,0x49u,0x44u,0x41u,0x54u,0x18u,0xd3u,0x6du,0x8fu,0x6du,0x13u,0x80u,0x10u,0x10u,0x84u,0xa3u,0x10u,0xbdu,0x77u,0x54u,0xffu,0xffu,0x97u,0xb6u,0xb8u,0x86u,0x19u,0x3du,0x5fu,0xd8u,0xb5u,0x37u,0xf6u,0xbau,0x7fu,0x7au,0x29u,0x84u,0xecu,0x8bu,0x36u,0x23u,0x81u,0x41u,0x7fu,0x5au,0x11u,0xa3u,0xb2u,0xd6u,0xb8u,0x5eu,0x21u,0xdcu,0x38u,0x4cu,0xd4u,0xc7u,0x40u,0x14u,0x3cu,0x08u,0x98u,0x3au,0x61u,0xacu,0x78u,0xf7u,0x09u,0x64u,0x36u,0x18u,0x53u,0x0au,0x70u,0x64u,0x86u,0x21u,0x6au,0x43u,0xc0u,0xd8u,0xebu,0x11u,0x19u,0x4bu,0x59u,0xa2u,0x87u,0x03u,0xb6u,0x8bu,0xb8u,0xf2u,0xadu,0x6cu,0x8au,0x31u,0x3au,0x57u,0x37u,0xd5u,0x72u,0x6eu,0xe1u,0xe5u,0x5au,0x5eu,0x29u,0x5cu,0x09u,0xbbu,0x4au,0xa8u,0x76u,0x96u,0x00u,0x00u,0x00u,0x00u,0x49u,0x45u,0x4eu,0x44u,0xaeu,0x42u,0x60u,0x82u};
    bulletImage = LoadImageFromMemory(".png", bullet_png, 282);
  }

  Assets.tankTexture = LoadTextureFromImage(tankImage);
  Assets.deadTankTexture = LoadTextureFromImage(deadTankImage);
  Assets.bulletTexture = LoadTextureFromImage(bulletImage);

  CreateTankRED(fRandom()*700.0f+50.0f, fRandom()*500.0f+50.0f, fRandom()*360.0f);
  CreateTankGREEN(fRandom()*700.0f+50.0f, fRandom()*500.0f+50.0f, fRandom()*360.0f);
  CreateTankBLUE(fRandom()*700.0f+50.0f, fRandom()*500.0f+50.0f, fRandom()*360.0f);

  void (*RenderSystem[])(void) = {
    [GameState_MENU] = RenderSystemMENU,
    [GameState_CHOOSE] = RenderSystemCHOOSE,
    [GameState_GAME] = RenderSystemGAME,
    [GameState_PAUSE] = RenderSystemPAUSE,
    [GameState_WIN] = RenderSystemWIN
  };

  void (*UpdateSystem[])(f32) = {
    [GameState_MENU] = NothingSystem,
    [GameState_CHOOSE] = NothingSystem,
    [GameState_GAME] = UpdateSystemGAME,
    [GameState_PAUSE] = NothingSystem,
    [GameState_WIN] = UpdateSystemWIN
  };

  void (*InputSystem[])(f32) = {
    [GameState_MENU] = InputSystemMENU,
    [GameState_CHOOSE] = InputSystemCHOOSE,
    [GameState_GAME] = InputSystemGAME,
    [GameState_PAUSE] = InputSystemPAUSE,
    [GameState_WIN] = InputSystemGAME
  };

  while (running)
  {
    if (WindowShouldClose()) running = false;

    f32 dt = GetFrameTime();

    InputSystem[gameState](dt);
    UpdateSystem[gameState](dt);

    ClearBackground(LIGHTGRAY);
    BeginDrawing();
    RenderSystem[gameState]();
    EndDrawing();
  }

  UnloadImage(tankImage);
  UnloadImage(deadTankImage);
  UnloadImage(bulletImage);
  UnloadTexture(Assets.tankTexture);
  UnloadTexture(Assets.deadTankTexture);
  UnloadTexture(Assets.bulletTexture);

  CloseWindow();
  return 0;
}
